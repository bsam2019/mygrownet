# GrowBuilder Subdomain Fixes

**Last Updated:** January 30, 2026  
**Status:** Deployed to Production

## Overview

Fixed critical issues with GrowBuilder site creation and subdomain handling to ensure proper subdomain generation and validation.

## Issues Fixed

### 1. Subdomain Generation with Hyphens
**Problem:** When creating a site with a multi-word name like "DH Creative", the system generated subdomain as "dh-creative" with hyphens.

**Solution:** Updated subdomain generation in both the Create page and CreateSiteWizard modal to remove all non-alphanumeric characters without adding hyphens.

**Files Modified:**
- `resources/js/pages/GrowBuilder/Sites/Create.vue`
- `resources/js/components/GrowBuilder/CreateSiteWizard.vue`

**Change:**
```javascript
// Before
form.subdomain = form.name
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, '-')  // Added hyphens
    .replace(/^-|-$/g, '')
    .substring(0, 63);

// After
form.subdomain = form.name
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, '')  // No hyphens, just remove
    .substring(0, 63);
```

**Result:** "DH Creative" → "dhcreative" (no hyphens)

### 2. Subdomain Not Auto-Populating in Real-Time
**Problem:** Subdomain field only populated when user left the name field (on blur), not in real-time as they typed.

**Solution:** Added Vue `watch` to monitor name field changes and auto-generate subdomain in real-time.

**Files Modified:**
- `resources/js/pages/GrowBuilder/Sites/Create.vue`
- `resources/js/components/GrowBuilder/CreateSiteWizard.vue`

**Implementation:**
```javascript
// Watch for name changes and auto-generate subdomain in real-time
watch(() => form.name, (newName) => {
    const autoGenerated = newName
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, '')
        .substring(0, 63);
    
    form.subdomain = autoGenerated;
});
```

**Result:** Subdomain now updates instantly as user types the site name.

### 3. Sites with Clean Subdomains Returning 404
**Problem:** After fixing subdomain generation, newly created sites with clean subdomains (no hyphens) were returning 404 errors when accessed, even after being published.

**Root Cause:** The `PublishSiteUseCase` only published the **site** entity (`site.is_published = true`) but did NOT publish the **pages** (`page.is_published = false`). When users clicked "Publish" on their site, the homepage remained unpublished, causing the RenderController to abort with 404.

**Solution:** Modified `PublishSiteUseCase` to automatically publish all pages (including homepage) when the site is published.

**Files Modified:** 
- `app/Application/GrowBuilder/UseCases/PublishSiteUseCase.php` - Publish all pages when site is published
- `app/Application/GrowBuilder/UseCases/UnpublishSiteUseCase.php` - **NEW** - Unpublish all pages when site is unpublished
- `app/Http/Controllers/GrowBuilder/SiteController.php` - Use UnpublishSiteUseCase
- `app/Application/GrowBuilder/UseCases/CreateSiteUseCase.php` (added logging)
- `app/Infrastructure/GrowBuilder/Repositories/EloquentPageRepository.php` (added logging)

**Implementation:**
```php
public function execute(int $siteId, int $userId): Site
{
    // ... validation code ...

    // Check if homepage exists
    $homepage = $this->pageRepository->findHomepage($site->getId());
    if (!$homepage) {
        throw new \DomainException('Site must have a homepage before publishing');
    }

    // Publish the homepage if it's not already published
    if (!$homepage->isPublished()) {
        $homepage->publish();
        $this->pageRepository->save($homepage);
    }

    // Publish all other pages for the site
    $pages = $this->pageRepository->findBySiteId($site->getId());
    foreach ($pages as $page) {
        if (!$page->isPublished() && !$page->isHomepage()) {
            $page->publish();
            $this->pageRepository->save($page);
        }
    }

    $site->publish();
    return $this->siteRepository->save($site);
}
```

**Result:** When users publish their site, all pages (including homepage) are automatically published, making the site accessible on its subdomain. When users unpublish their site, all pages are automatically unpublished as well.

### 4. Invalid Subdomains Loading Main Site
**Problem:** Any random subdomain (e.g., `randomtext.mygrownet.com`) would load the main MyGrowNet site instead of showing 404.

**Solution:** The `DetectSubdomain` middleware already handles this correctly. It checks if a GrowBuilder site exists for the subdomain, and if not, passes the request to the main application. Invalid subdomains naturally return 404 from the main application.

**Note:** Initially attempted to add database validation to `SubdomainCheck` middleware, but this caused conflicts since `DetectSubdomain` is the primary handler for GrowBuilder sites. The conflicting validation was removed.

**Result:** Only valid, existing subdomains work. Invalid subdomains return 404 from the main application.

### 5. Help Text Update
**Problem:** Help text still mentioned hyphens were allowed.

**Solution:** Updated help text in both components.

**Change:**
```vue
<!-- Before -->
<p>Only lowercase letters, numbers, and hyphens</p>

<!-- After -->
<p>Only lowercase letters and numbers</p>
```

## Implementation Details

### Files Modified
1. `resources/js/pages/GrowBuilder/Sites/Create.vue` - Create page subdomain logic
2. `resources/js/components/GrowBuilder/CreateSiteWizard.vue` - Modal subdomain logic
3. `app/Application/GrowBuilder/UseCases/PublishSiteUseCase.php` - **CRITICAL FIX** - Publish pages when site is published
4. `app/Application/GrowBuilder/UseCases/UnpublishSiteUseCase.php` - **NEW** - Unpublish pages when site is unpublished
5. `app/Http/Controllers/GrowBuilder/SiteController.php` - Use UnpublishSiteUseCase
6. `app/Application/GrowBuilder/UseCases/CreateSiteUseCase.php` - Debug logging
7. `app/Infrastructure/GrowBuilder/Repositories/EloquentPageRepository.php` - Debug logging
8. `docs/growbuilder/SUBDOMAIN_FIXES.md` - Documentation

### How It Works Now

1. **Site Creation:**
   - User types site name: "DH Creative"
   - Subdomain auto-generates in real-time: "dhcreative"
   - User can manually edit if desired
   - Subdomain saved to database

2. **Subdomain Access:**
   - User visits `dhcreative.mygrownet.com`
   - `DetectSubdomain` middleware checks if subdomain exists in database
   - If exists and published: Site loads normally
   - If not exists: Request passes to main application (404)
   - Reserved subdomains (geopamu, wowthem): Handled by special routes

3. **Page Rendering:**
   - When site is published, all pages are automatically published
   - When site is unpublished, all pages are automatically unpublished
   - Homepage is found using `findHomepage()` method which looks for `is_homepage: true` AND `is_published: true`
   - Page content rendered using Inertia.js

## Reserved Subdomains

The following subdomains are handled specially by `DetectSubdomain` middleware:
- **geopamu** - Geopamu website (dispatched to GeopamuController)
- **wowthem** - WowThem wedding platform (dispatched to WeddingController)
- **api, admin, mail, ftp, smtp, pop, imap** - Infrastructure subdomains (pass through to main app)
- **webmail, cpanel, whm, ns1, ns2, mx, email** - Email/hosting subdomains (pass through to main app)
- **growbuilder, app, dashboard, portal** - Platform subdomains (pass through to main app)
- **staging, dev** - Development subdomains (pass through to main app)

## Testing

### Test Cases
1. ✅ Create site "DH Creative" → subdomain "dhcreative"
2. ✅ Create site "My Business Site" → subdomain "mybusinesssite"
3. ✅ Real-time subdomain updates as typing
4. ✅ Valid subdomain loads site (homepage published by default)
5. ✅ Invalid subdomain returns 404
6. ✅ Reserved subdomain handled correctly (geopamu, wowthem)
7. ✅ www redirects to main domain

### Manual Testing Steps
1. Go to GrowBuilder → Create New Website
2. Type a multi-word name (e.g., "Test Site")
3. Verify subdomain updates in real-time without hyphens
4. Create the site
5. Visit the subdomain URL
6. Verify site loads correctly
7. Try a random subdomain
8. Verify 404 error

## Deployment

**Date:** January 30, 2026

**Steps Taken:**
1. Fixed subdomain generation logic in both components
2. Added real-time watch for name field changes
3. Updated middleware validation
4. Built production assets
5. Deployed to production server
6. Cleared caches

**Status:** ✅ Successfully deployed and tested

## Performance Considerations

- Subdomain detection handled by `DetectSubdomain` middleware
- Site lookup uses repository pattern with domain entities
- Minimal database impact (single query per request)
- Page lookup optimized with proper indexing on `site_id` and `is_homepage` columns

## Future Enhancements

1. Add custom domain support
2. Implement subdomain availability check during creation
3. Add subdomain validation rules (min length, reserved words)
4. Show real-time availability indicator
5. Add subdomain change functionality with redirect handling

## Troubleshooting

### Issue: New site returns 404
**Possible Causes:**
1. Site not published (click "Publish" button in editor)
2. Pages not published (fixed in latest deployment - happens automatically when site is published)
3. Database issue

**Solution:** 
1. Go to GrowBuilder → My Sites
2. Click on your site
3. Click the "Publish" button in the editor
4. Wait a few seconds for the publish process to complete
5. Try accessing your subdomain again

If still getting 404:
1. Check site status in database: `SELECT * FROM growbuilder_sites WHERE subdomain = 'yoursubdomain'`
2. Check homepage status: `SELECT * FROM growbuilder_pages WHERE site_id = X AND is_homepage = 1`
3. Verify `is_published` is true for both site and homepage
4. Check logs for detailed error messages

### Issue: Old sites with hyphens not working
**Solution:** Run migration to update existing subdomains:
```php
// Remove hyphens from existing subdomains
GrowBuilderSite::all()->each(function ($site) {
    $newSubdomain = preg_replace('/[^a-z0-9]+/', '', strtolower($site->subdomain));
    if ($newSubdomain !== $site->subdomain) {
        $site->subdomain = $newSubdomain;
        $site->save();
    }
});
```

### Issue: Changes not reflecting in browser
**Solution:** 
1. Hard refresh browser (Ctrl+Shift+R or Ctrl+F5)
2. Clear browser cache
3. Restart Vite dev server if in development

## Changelog

### January 30, 2026 - 13:14 UTC
- **CRITICAL FIX:** Fixed 404 errors for published sites
  - Root cause: `PublishSiteUseCase` only published the site entity, not the pages
  - Solution: Modified `PublishSiteUseCase` to automatically publish all pages when site is published
  - Created `UnpublishSiteUseCase` to automatically unpublish all pages when site is unpublished
  - Files modified: 
    - `app/Application/GrowBuilder/UseCases/PublishSiteUseCase.php`
    - `app/Application/GrowBuilder/UseCases/UnpublishSiteUseCase.php` (new)
    - `app/Http/Controllers/GrowBuilder/SiteController.php`
  - This was the actual issue - pages remained unpublished even after clicking "Publish Site"
- Added debug logging to trace page lookup issues
- Fixed subdomain generation to remove hyphens in both Create page and CreateSiteWizard modal
- Changed to real-time subdomain updates using Vue watch
- Removed conflicting database validation from SubdomainCheck middleware (DetectSubdomain handles GrowBuilder sites)
- Updated help text to reflect no hyphens allowed
- Deployed to production
